{"version":3,"sources":["pjax.js"],"names":["$","window","history","pushState","replaceState","scrollToMainTop","postTop","document","getElementById","offsetTop","navHeight","offsetHeight","theTop","animate","scrollTop","setMetaProperty","doc","property","content","meta","querySelector","setAttribute","parentNode","removeChild","createElement","head","appendChild","getMetaProperty","els","getAttribute","replacePageContent","data","title","oldMain","replaceWith","innerHTML","scripts","getElementsByTagName","i","length","script","type","toLowerCase","newScript","src","createTextNode","text","insertBefore","ogTitle","ogUrl","OriginTitile","getPageData","url","addEventListener","e","state","pjax","dispatchEvent","pjaxEvents","complete","before","Event","success","error","reqUrl","needPushState","onError","location","href","request","XMLHttpRequest","onerror","console","bubbleNoticer","ontimeout","onreadystatechange","readyState","responseText","newDoc","implementation","createHTMLDocument","documentElement","setTimeout","open","reqId","match","offset","top","NProgress","done","onComplete","timeout","load_comm","start","send","on","this","attr","includes","decodeURI"],"mappings":"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","file":"../js/pjax.min.js","sourcesContent":["$(function () {\r\n    if (!window.history ||\r\n        !window.history.pushState ||\r\n        !window.history.replaceState) {\r\n        return;\r\n    }\r\n\r\n    function scrollToMainTop() {\r\n        const postTop = document.getElementById(\"kratos-blog-post\").offsetTop\r\n        const navHeight = document.getElementById(\"kratos-desktop-topnav\").offsetHeight;\r\n        const theTop = navHeight ? postTop - navHeight : 0;\r\n        $(\"body,html\").animate({ scrollTop: theTop }, 600);\r\n    }\r\n\r\n    function setMetaProperty(doc, property, content) {\r\n        var meta = doc.querySelector('meta[property=\"' + property + '\"]');\r\n        if (meta) {\r\n            if (content) {\r\n                meta.setAttribute('content', content);\r\n            } else {\r\n                // 兼容性考虑，不直接使用 remove\r\n                if (meta.parentNode) {\r\n                    meta.parentNode.removeChild(meta);\r\n                }\r\n            }\r\n        } else {\r\n            if (!content) {\r\n                return;\r\n            }\r\n            meta = doc.createElement('meta');\r\n            meta.setAttribute('property', property);\r\n            meta.setAttribute('content', content);\r\n            doc.head.appendChild(meta);\r\n        }\r\n    }\r\n\r\n    function getMetaProperty(doc, property) {\r\n        const els = doc.querySelector('meta[property=\"' + property + '\"]');\r\n        return els ? els.getAttribute('content') : null;\r\n    }\r\n\r\n    function replacePageContent(data, doc) {\r\n        document.title = data.title || 'Untitled';\r\n        if (doc) {\r\n            const oldMain = document.getElementById(\"main\");\r\n            if (typeof oldMain.replaceWith === 'function') {\r\n                // 避免多次解析DOM树带来的性能损失\r\n                oldMain.replaceWith(doc.getElementById(\"main\"));\r\n            } else {\r\n                document.getElementById(\"main\").innerHTML = data.content;\r\n            }\r\n        } else {\r\n            document.getElementById(\"main\").innerHTML = data.content;\r\n        }\r\n        // JS必须手动执行\r\n        const scripts = document.getElementById(\"main\").getElementsByTagName(\"script\");\r\n        for (var i = 0; i < scripts.length; i++) {\r\n            const script = scripts[i];\r\n            if (!script.type || script.type.toLowerCase() === \"text/javascript\") {\r\n                var newScript = document.createElement(\"script\");\r\n                newScript.setAttribute('type', 'text/javascript');\r\n                if (script.src) {\r\n                    newScript.src = script.src;\r\n                } else {\r\n                    newScript.appendChild(document.createTextNode(script.text));\r\n                }\r\n                if (typeof script.replaceWith === 'function') {\r\n                    script.replaceWith(newScript);\r\n                } else {\r\n                    // 兼容性考虑\r\n                    script.parentNode.insertBefore(newScript, script);\r\n                    script.parentNode.removeChild(script);\r\n                }\r\n            }\r\n        }\r\n        // 更新部分元数据\r\n        // 使用部分组件时可能会自动读取这些数据（如LiveRe评论系统）\r\n        setMetaProperty(document, 'og:title', data.ogTitle);\r\n        setMetaProperty(document, 'og:url', data.ogUrl);\r\n\r\n        // 更新外域变量\r\n        OriginTitile = document.title;\r\n    }\r\n    function getPageData(url, doc) {\r\n        return {\r\n            url: url,\r\n            title: doc.title,\r\n            ogTitle: getMetaProperty(doc, 'og:title'),\r\n            ogUrl: getMetaProperty(doc, 'og:url'),\r\n            content: doc.getElementById(\"main\").innerHTML,\r\n        }\r\n    }\r\n\r\n    function popStateHandler(e) {\r\n        if (e.state) {\r\n            scrollToMainTop();\r\n            if (typeof e.state.content === 'undefined') {\r\n                pjax(e.state.url, false);\r\n            } else {\r\n                replacePageContent(e.state)\r\n            }\r\n            window.dispatchEvent(pjaxEvents.complete);\r\n        }\r\n    };\r\n    window.addEventListener('popstate', popStateHandler);\r\n\r\n    const pjaxEvents = {\r\n        before: new Event('pjax:before'),\r\n        success: new Event('pjax:success'),\r\n        complete: new Event('pjax:complete'),\r\n        error: new Event('pjax:error'),\r\n    };\r\n\r\n    function pjax(reqUrl, needPushState) {\r\n        const beforeSend = () => {\r\n            // 防止评论区再被加载，重置加载函数\r\n            if (typeof load_comm !== 'undefined' && load_comm !== null) {\r\n                load_comm = null;\r\n            }\r\n\r\n            scrollToMainTop();\r\n            NProgress.start();\r\n            bubbleNoticer(\"请求页面中\",\"normal\",\"3000\");\r\n            window.dispatchEvent(pjaxEvents.before);\r\n        }\r\n        const onError = () => {\r\n            location.href = reqUrl;\r\n            window.dispatchEvent(pjaxEvents.error);\r\n        }\r\n        const onComplete = (responseText) => {\r\n            window.dispatchEvent(pjaxEvents.success);\r\n            const newDoc = document.implementation.createHTMLDocument(\"pjax\");\r\n            newDoc.documentElement.innerHTML = responseText;\r\n            const isSuccessRequest = !!newDoc.getElementById(\"main\");\r\n            if (isSuccessRequest) {\r\n                history.replaceState(getPageData(location.href, document), document.title, location.href);\r\n                const data = getPageData(reqUrl, newDoc)\r\n                bubbleNoticer(\"请求成功\",\"ok\",\"3000\");\r\n                if (needPushState) {\r\n                    window.history.pushState(data, data.title, data.url);\r\n                }\r\n                replacePageContent(data, newDoc);\r\n\r\n                // 如果URL里有指定节点ID，则滚动到相应的节点位置\r\n                const reqId = reqUrl.match(/\\#.+$/);\r\n                if (reqId) {\r\n                    $(\"body,html\").animate({ scrollTop: $(reqId[0]).offset().top - 40 }, 600);\r\n                }\r\n            } else {\r\n                bubbleNoticer(\"似乎超时了，准备三秒后新建页面\",\"problem\",\"3000\");\r\n                // 其实是失败的\r\n                // 不如打开一个新页面？\r\n                setTimeout(()=>{window.open(reqUrl);},3500)\r\n            }\r\n            NProgress.done();\r\n            window.dispatchEvent(pjaxEvents.complete);\r\n        }\r\n        const request = new XMLHttpRequest();\r\n        request.onerror = function (e) {\r\n            console.error(e);\r\n            onError();\r\n            bubbleNoticer(\"请求出错啦\",\"err\",\"3000\");\r\n        };\r\n        request.ontimeout = function () {\r\n            onError();\r\n        };\r\n        request.onreadystatechange = function () {\r\n            if (request.readyState === 4) {\r\n                onComplete(request.responseText);\r\n            }\r\n        };\r\n        request.open(\"GET\", reqUrl, true);\r\n        request.timeout = 6000;\r\n        beforeSend();\r\n        request.send();\r\n    }\r\n    $(document).on(\"click\", 'a[target!=_blank][rel!=gallery][class!=toc-link]', function () {\r\n        const reqUrl = $(this).attr(\"href\");\r\n        if (typeof reqUrl === 'undefined') return true;\r\n        else if (reqUrl.includes(\"javascript:\")) return true;\r\n        else pjax(decodeURI(reqUrl), true);\r\n        return false;\r\n    });\r\n});\r\n"]}